##########################
# BASE CONFIG
##########################
.release_base: &release_base
  image: node:16-alpine
  stage: release
  before_script:
    - apk add git
    - yarn install --network-timeout 1000000
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

##########################
# COMMIT LINT
##########################
commitlint:
  extends: .release_base
  script:
    - yarn run commitlint
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: $CI_COMMIT_TAG
      when: never
  needs: [] # FIXME: remove

##########################
# SEMANTIC RELEASE
##########################
semantic_release:
  extends: .release_base
  script:
    - yarn run semantic-release
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: manual
      allow_failure: true
      # The combination `when: manual` and `allow_failure: true` allow this step to be manual without blocking
      # the pipeline. See https://docs.gitlab.com/ee/ci/yaml/README.html#rulesallow_failure
